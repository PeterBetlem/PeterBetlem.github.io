<!DOCTYPE html>
<html>
<head>
    <title>sidebar-v2 example</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        crossorigin=""/>

    <link rel="stylesheet" href="https://www.unpkg.com/leaflet-sidebar-v2@3.2.3/css/leaflet-sidebar.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" crossorigin="">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">

    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

        .lorem {
            font-style: italic;
            text-align: justify;
            color: #AAA;
        }

        
        .csl-entry {
            padding: 5px;
            display: list-item; 
        }
    </style>
</head>
<body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/citation-js/0.6.7/citation.min.js" integrity="sha512-N+LDFMa9owHXGS+CyMrBvuxq2QuGl3fiB/7cys3aUEL7K6P1soHGqsS0sjHXZpwNd9Kz0m3R4IPy1HYRi6ROEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        crossorigin=""></script>
    <script src="https://www.unpkg.com/leaflet-sidebar-v2@3.2.3/js/leaflet-sidebar.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/citeproc-js-es5@1.0.4/dist/citeproc.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
    

    <!-- optionally define the sidebar content via HTML markup -->
    <div id="sidebar" class="leaflet-sidebar collapsed">

        <!-- nav tabs -->
        <div class="leaflet-sidebar-tabs">
            <!-- top aligned tabs -->
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa-solid fa-circle-info"></i></a></li>
                <li><a href="#projects" role="tab"><i class="fa-solid fa-map-location-dot"></i></a></li>
                <li><a href="#events" role="tab"><i class="fa-solid fa-street-view"></i></a></li>
                <li><a href="#publications" role="tab"><i class="fa-solid fa-file-contract"></i></a></li>
                <li><a href="#teaching" role="tab"><i class="fa-solid fa-person-chalkboard"></i></a></li>
                <li><a href="#grants" role="tab"><i class="fa-solid fa-magnifying-glass-dollar"></i></a></li>
                <li><a href="#contact" role="tab"><i class="fa fa-address-card"></i></a></li>
            </ul>

            <!-- bottom aligned tabs -->
            <ul role="tablist">
                <li><a href="https://github.com/PeterBetlem" target=”_blank”><i class="fa-brands fa-github"></i></a></li>
                <li><a href="https://scholar.google.com/citations?user=vdV4YxIAAAAJ&hl=en&oi=ao" target=”_blank”><i class="fa-brands fa-google"></i></a></li>
            </ul>
        </div>

        <!-- panel content -->
        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane" id="home">
                <h1 class="leaflet-sidebar-header">
                    About Peter Betlem
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <div id="home-content">
                </div>
            </div>
            <div class="leaflet-sidebar-pane" id="teaching">
                <h1 class="leaflet-sidebar-header">
                    Teaching portfolio
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <div id="home-content">
                </div>
            </div>

            <div class="leaflet-sidebar-pane" id="projects">
                <h1 class="leaflet-sidebar-header">
                    Projects
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <div id="projects-content-header">
                </div>
                <hr>
                <div id="projects-content">
                </div>
            </div>

            <div class="leaflet-sidebar-pane" id="events">
                <h1 class="leaflet-sidebar-header">
                    Map events
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <div id="events-content">
                </div>
            </div>

            <div class="leaflet-sidebar-pane" id="publications">
                <h1 class="leaflet-sidebar-header">
                    Scientific record
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <div id="publications-content">

                    <h3>
                        Recent Journal Publications
                    </h3>

                        <div id="publications-list">

                        </div>

                    <h3>
                        Recent Conference Proceedings
                    </h3>

                        <div id="conferences-list">

                        </div>
                        
                    <p>A more extensive list can be found at <a href="https://scholar.google.com/citations?user=vdV4YxIAAAAJ&hl=en&oi=ao">Google Scholar</a>.</p>


                </div>
            </div>

            <div class="leaflet-sidebar-pane" id="grants">
                <h1 class="leaflet-sidebar-header">
                    Grants & support
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <div id="grants-content">
                </div>
            </div>
            
            <div class="leaflet-sidebar-pane" id="contact">
                <h1 class="leaflet-sidebar-header">
                    Contact details
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <div id="contact-content">
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <!-- <a href="https://github.com/nickpeihl/leaflet-sidebar-v2/"><img style="position: fixed; top: 0; right: 0; border: 0; z-index: 1000;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>
    -->

    <script>
        $( "#home-content" ).load( "./pages/home.html" );
        $( "#projects-content-header" ).load( "./pages/projects.html" );
        $( "#contact-content" ).load( "./pages/contact.html" );
    </script>

    <script>
        var chosenLibraryItems = "https://api.zotero.org/users/2084519/publications/items?format=csljson&limit=5&itemType=journalArticle&sort=date";
        var xhr = new XMLHttpRequest();
        xhr.open('GET', chosenLibraryItems, false);
        xhr.send(null);
        var citationData = JSON.parse(xhr.responseText);
        const Cite = require('citation-js')
        var citationData = citationData.items
        var papers = new Cite()

        papers.set(citationData)
        
        $('#publications-list').html(papers.format('bibliography', { format: 'html', template: 'geology', nosort: true }))

        
        var chosenLibraryItems = "https://api.zotero.org/users/2084519/publications/items?format=csljson&limit=5&itemType=conferencePaper&sort=date";
        var xhr = new XMLHttpRequest();
        xhr.open('GET', chosenLibraryItems, false);
        xhr.send(null);
        var citationData = JSON.parse(xhr.responseText);
        var data = citationData.items
        var conferences = new Cite()

        conferences.set(data)
        
        $('#conferences-list').html(conferences.format('bibliography', { format: 'html', template: 'geology', nosort: true }))
        
           
    </script>

    <script>
        // standard leaflet map setup
        var map = L.map('map');
        map.setView([67, 10], 4);
        const OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Map data &copy; OpenStreetMap contributors | Svalbox'
        });

        const doms_request = "https://svalbox.unis.no/arcgis/rest/services/dom/DOM/FeatureServer/1/query?where=1%3D1&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&distance=&units=esriSRUnit_Foot&relationParam=&outFields=*&returnGeometry=true&maxAllowableOffset=&geometryPrecision=&outSR=&gdbVersion=&returnDistinctValues=false&returnIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&multipatchOption=&resultOffset=&resultRecordCount=&f=geojson"
        const doms_layer = L.geoJson(null, {
            style: {
                fillColor: "red",
                color: "red",
                weight: 1,
            },
            onEachFeature: onEachFeature,
            id: "dom"
            }
        )
        $.getJSON(doms_request, function(data){
        // L.geoJson function is used to parse geojson file and load on to map
        doms_layer.addData(data)
        })
        .success(function(){
            console.log("Successfully retrieved GIS objects.")
        })
        .fail(function(){
            alert('Failed to access Svalbox GIS data')
            console.log("Failed to retrieve Svalbox GIS objects.")
        })
        
        var img360_markers = L.markerClusterGroup({
            spiderfyOnMaxZoom: false,
            showCoverageOnHover: false
            }); 
        const img360_request = "https://svalbox.unis.no/arcgis/rest/services/Images/images360/MapServer/0/query?where=1%3D1&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&distance=&units=esriSRUnit_Foot&relationParam=&outFields=*&returnGeometry=true&maxAllowableOffset=&geometryPrecision=&outSR=&gdbVersion=&returnDistinctValues=false&returnIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&multipatchOption=&resultOffset=&resultRecordCount=&f=geojson"
        const img360_layer = L.geoJson(null, {
            pointToLayer: function(feature, latlng) {

                return L.circleMarker(latlng, {
                radius:3,
                opacity: .5,
                color: "yellow",
                //color:getColor(feature.properties.League),
                //fillColor:  getColor(feature.properties.League),
                fillOpacity: 0.8

                });  //.bindTooltip(feature.properties.Name);
                },
            onEachFeature: onEachFeature,
            id: "img360"
            }
        )
        $.getJSON(img360_request, function(data){
        // L.geoJson function is used to parse geojson file and load on to map
        img360_layer.addData(data)
        // img360_markers.addLayer(img360_layer)

        })
        .success(function(){
            console.log("Successfully retrieved GIS objects.")
        })
        .fail(function(){
            alert('Failed to access Img360 GIS data')
            console.log("Failed to retrieve Img360 GIS objects.")
        })

        var geojsonMarkerOptions = {
            radius: 100,
            fillColor: "#ff7800",
            color: "#000",
            weight: 1,
            opacity: 0.5,
            fillOpacity: 0.8
        };

        var myRequest = "https://wms.qgiscloud.com/peterbetlem/rnd?service=WFS&request=GetFeature";
        var outputFormat = "outputformat=geojson";
        var areasRequest = myRequest + "&typename=areas&" + outputFormat; 


        function onEachFeature (feature, layer) {
            layer.on("click", function(e){
                console.log(layer)
                console.log(img360_markers._leaflet_id.toString())
                console.log(img360_layer._leaflet_id.toString())
                switch (Object.keys(layer._eventParents)[0].toString()) {
                    case datalayer._leaflet_id.toString():
                        featureDetails = document.getElementById("projects-content");
                        featureDetails.innerHTML = "<p>" + feature.properties.description + "</p>"
                        sidebar.open("projects")
                        break
                    case doms_layer._leaflet_id.toString():
                        featureDetails = document.getElementById("events-content");
                        featureDetails.innerHTML = '<br><div class="sketchfab-embed-wrapper"> <iframe style="width:100%;height:95%;position:absolute;left:0px;top:44px;" width=100% frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share src="https://sketchfab.com/models/' + feature.properties.publ_sketchfab_id + '/embed"></iframe></div>'
                        sidebar.open("events")
                        break
                    case img360_layer._leaflet_id.toString():
                        console.log(e)
                        featureDetails = document.getElementById("events-content");
                        featureDetails.innerHTML = '<br><div class="sketchfab-embed-wrapper"> <iframe style="width:100%;height:95%;position:absolute;left:0px;top:44px;" width=100% <iframe width="100%" height="150%" allowfullscreen style="border-style:none;"'+
                             ' src="https://cdn.pannellum.org/2.5/pannellum.htm#panorama='+feature.properties.api_link+'&autoLoad=false"></iframe></div>'
                        sidebar.open("events")
                        break
                    }
                /*
                console.log(layer)
                featureDetails = document.getElementById("projects-content");
                console.log(feature.properties.name)
                featureDetails.innerHTML = "<p>" + feature.properties.description + "</p>"
                sidebar.open("projects")*/
        })
        }

        // help from: https://gis.stackexchange.com/questions/335598/leaflet-search-plugin-for-getjson-function
        const datalayer = L.geoJson(null, {

            pointToLayer: function(feature, latlng) {

                return L.circleMarker(latlng, {
                radius:6,
                opacity: .5,
                //color: "#000",
                //color:getColor(feature.properties.League),
                //fillColor:  getColor(feature.properties.League),
                fillOpacity: 0.8

                });  //.bindTooltip(feature.properties.Name);
            },
            onEachFeature: onEachFeature,
            id: "projects"
            });

        $.getJSON(areasRequest, function(data){
        // L.geoJson function is used to parse geojson file and load on to map
        datalayer.addData(data)
        })
        .success(function(){
            console.log("Successfully retrieved GIS objects.")
        })
        .fail(function(){
            alert('Failed to access project GIS data')
            console.log("Failed to retrieve project GIS objects.")
        })

        




        const mapLayers = [
                {
                    layer: OSM,
                    defaultAdd: true,
                    baseLayerControl: true,
                    title: "OSM",
                },
                {
                    layer: doms_layer,
                    eventType: "DOMs",
                    overlayLayerControl: true,
                    title: "DOMs",
                },
                {
                    layer: img360_layer,
                    eventType: "img360",
                    overlayLayerControl: true,
                    title: "Photospheres",
                },
                {
                    layer: datalayer,
                    eventType: "projects",
                    overlayLayerControl: true,
                    title: "Projects",
                },
            ]

        mapLayers.forEach((layerObj) => {
            if (layerObj.defaultAdd) {
                //console.log(layerObj)
            }

            if (layerObj.eventType !== "undefined") {
                //console.log(layerObj)
                layerObj.layer.addTo(map)
                //layerObj.layer.on("click", (evt) => {
                    //console.log(layerObj.layer)
                    //sidebar.update(evt.layer.feature.properties, layerObj.eventType)
                //)
            }
            })
  

        // create the sidebar instance and add it to the map
        var sidebar = L.control.sidebar({ container: 'sidebar' })
        /*sidebar.update = function (props, type) {
            switch (type) {
            case "projects":
                console.log(props)
                break
            }
        }*/
        sidebar
            .addTo(map)
            .open('home')

        /*// add panels dynamically to the sidebar
        sidebar
            .addPanel({
                id:   'js-api',
                tab:  '<i class="fa fa-gear"></i>',
                title: 'JS API',
                pane: '<p>The Javascript API allows to dynamically create or modify the panel state.<p/><p><button onclick="sidebar.enablePanel(\'mail\')">enable mails panel</button><button onclick="sidebar.disablePanel(\'mail\')">disable mails panel</button></p><p><button onclick="addUser()">add user</button></b>',
            })
            // add a tab with a click callback, initially disabled
            .addPanel({
                id:   'mail',
                tab:  '<i class="fa fa-envelope"></i>',
                title: 'Messages',
                button: function() { alert('opened via JS callback') },
                disabled: true,
            })*/

        // be notified when a panel is opened
        sidebar.on('content', function (ev) {
            switch (ev.id) {
                case 'projects':
                sidebar.options.autopan = true;
                break;
                default:
                sidebar.options.autopan = true;
            }
        });

    </script>
</body>
</html>